<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABCå›½é™…å•†æœ - åå°ç®¡ç†</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@4.24.14/dist/antd.min.css">
    <script src="https://cdn.jsdelivr.net/npm/react@17.0.2/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17.0.2/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/antd@4.24.14/dist/antd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.21.4/babel.min.js"></script>
    <style>
        #app {
            min-height: 100vh;
        }
        .ant-layout {
            min-height: 100vh;
        }
        .admin-logo {
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 24px;
            color: #1e88e5;
            font-size: 20px;
            font-weight: bold;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
            overflow: hidden;
        }
        .ant-layout-content {
            padding: 24px;
            background: #f0f2f5;
        }
        .site-layout-content {
            padding: 24px;
            background: #fff;
            border-radius: 2px;
        }
        .ant-page-header {
            padding: 16px 24px;
            background: #fff;
            margin-bottom: 16px;
        }
        .filter-form {
            margin-bottom: 24px;
        }
        .table-container {
            background: #fff;
            padding: 24px;
            margin-bottom: 24px;
        }
        .page-subtitle {
            font-weight: bold;
            color: #000;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="text/babel">
        const { 
            Layout, Menu, Button, Table, Form, Input, 
            Select, DatePicker, Space, message, Modal,
            Dropdown
        } = antd;
        
        const { 
            HomeOutlined, SettingOutlined, TeamOutlined, 
            UserOutlined, DashboardOutlined 
        } = {
            HomeOutlined: () => 'ğŸ ',
            SettingOutlined: () => 'âš™ï¸',
            TeamOutlined: () => 'ğŸ‘¥',
            UserOutlined: () => 'ğŸ‘¤',
            DashboardOutlined: () => 'ğŸ“Š'
        };

        const { Option } = Select;
        const { RangePicker } = DatePicker;
        const { Header, Content, Sider } = Layout;

        // API åŸºç¡€URLé…ç½®
        const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_BASE_URL = isDevelopment 
            ? `http://${window.location.hostname}:5000`
            : window.location.protocol + '//' + window.location.hostname;

        // æ¬¢è¿é¡µé¢ç»„ä»¶
        function Welcome() {
            return (
                <div style={{ padding: '24px' }}>
                    <h2>æ¬¢è¿ä½¿ç”¨ABCå›½é™…å•†æœç®¡ç†åå°</h2>
                    <p>è¯·ä»å·¦ä¾§èœå•é€‰æ‹©è¦ç®¡ç†çš„å†…å®¹</p>
                </div>
            );
        };

        // è”ç³»äººåˆ—è¡¨ç»„ä»¶
        function ContactList({ contacts, loading }) {
            const [form] = Form.useForm();
            const [filteredContacts, setFilteredContacts] = React.useState([]);
            const [pagination, setPagination] = React.useState({
                current: 1,
                pageSize: 10,
                total: 0
            });

            React.useEffect(() => {
                setFilteredContacts(contacts);
                setPagination(prev => ({
                    ...prev,
                    total: contacts.length
                }));
            }, [contacts]);

            const columns = [
                {
                    title: 'ID',
                    dataIndex: 'id',
                    key: 'id',
                },
                {
                    title: 'å§“å',
                    dataIndex: 'name',
                    key: 'name',
                },
                {
                    title: 'å›½å®¶åŒºå·',
                    dataIndex: 'country_code',
                    key: 'country_code',
                },
                {
                    title: 'ç”µè¯å·ç ',
                    dataIndex: 'phone',
                    key: 'phone',
                },
                {
                    title: 'æäº¤æ—¶é—´',
                    dataIndex: 'submit_time',
                    key: 'submit_time',
                    render: (text) => moment(text).format('YYYY-MM-DD HH:mm:ss'),
                    defaultSortOrder: 'ascend',
                    sorter: (a, b) => new Date(a.submit_time) - new Date(b.submit_time)
                }
            ];

            const handleSearch = (values) => {
                const { name, phone, countryCode, dateRange } = values;
                
                let filtered = [...contacts];
                
                if (name) {
                    filtered = filtered.filter(item => 
                        item.name.toLowerCase().includes(name.toLowerCase())
                    );
                }
                
                if (phone) {
                    filtered = filtered.filter(item => 
                        item.phone.includes(phone)
                    );
                }
                
                if (countryCode) {
                    filtered = filtered.filter(item => 
                        item.country_code === countryCode
                    );
                }
                
                if (dateRange && dateRange.length === 2) {
                    const [start, end] = dateRange;
                    filtered = filtered.filter(item => {
                        const submitTime = moment(item.submit_time);
                        return submitTime.isBetween(start, end.endOf('day'));
                    });
                }
                
                setFilteredContacts(filtered);
                setPagination(prev => ({
                    ...prev,
                    current: 1,
                    total: filtered.length
                }));
            };

            const handleReset = () => {
                form.resetFields();
                setFilteredContacts(contacts);
                setPagination(prev => ({
                    ...prev,
                    current: 1,
                    total: contacts.length
                }));
            };

            return (
                <div>
                    <Form
                        form={form}
                        className="filter-form"
                        onFinish={handleSearch}
                        layout="inline"
                        style={{ marginBottom: '24px' }}
                    >
                        <Form.Item name="name">
                            <Input placeholder="æŒ‰å§“åæœç´¢" allowClear />
                        </Form.Item>
                        
                        <Form.Item name="phone">
                            <Input placeholder="æŒ‰ç”µè¯æœç´¢" allowClear />
                        </Form.Item>
                        
                        <Form.Item name="countryCode">
                            <Select 
                                placeholder="é€‰æ‹©å›½å®¶åŒºå·" 
                                allowClear
                                style={{ width: 160 }}
                            >
                                <Option value="+86">+86 (ä¸­å›½å¤§é™†)</Option>
                                <Option value="+852">+852 (é¦™æ¸¯)</Option>
                                <Option value="+853">+853 (æ¾³é—¨)</Option>
                                <Option value="+886">+886 (å°æ¹¾)</Option>
                                <Option value="+1">+1 (ç¾å›½/åŠ æ‹¿å¤§)</Option>
                                <Option value="+44">+44 (è‹±å›½)</Option>
                                <Option value="+81">+81 (æ—¥æœ¬)</Option>
                                <Option value="+82">+82 (éŸ©å›½)</Option>
                            </Select>
                        </Form.Item>
                        
                        <Form.Item name="dateRange">
                            <RangePicker />
                        </Form.Item>
                        
                        <Form.Item>
                            <Space>
                                <Button type="primary" htmlType="submit">
                                    æœç´¢
                                </Button>
                                <Button onClick={handleReset}>
                                    é‡ç½®
                                </Button>
                            </Space>
                        </Form.Item>
                    </Form>

                    <Table
                        columns={columns}
                        dataSource={filteredContacts}
                        rowKey="id"
                        pagination={pagination}
                        onChange={(newPagination) => setPagination(newPagination)}
                        loading={loading}
                    />
                </div>
            );
        }

        // ç”¨æˆ·ç®¡ç†ç»„ä»¶
        function UserManagement() {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(false);
            const [modalVisible, setModalVisible] = useState(false);
            const [passwordModalVisible, setPasswordModalVisible] = useState(false);
            const [selectedUser, setSelectedUser] = useState(null);
            const [form] = Form.useForm();
            const [passwordForm] = Form.useForm();

            const columns = [
                {
                    title: 'ID',
                    dataIndex: 'id',
                    key: 'id',
                },
                {
                    title: 'ç”¨æˆ·å',
                    dataIndex: 'username',
                    key: 'username',
                },
                {
                    title: 'åˆ›å»ºæ—¶é—´',
                    dataIndex: 'created_at',
                    key: 'created_at',
                    render: (text) => moment(text).format('YYYY-MM-DD HH:mm:ss'),
                    defaultSortOrder: 'ascend',
                    sorter: (a, b) => new Date(a.created_at) - new Date(b.created_at)
                },
                {
                    title: 'æ“ä½œ',
                    key: 'action',
                    render: (_, record) => (
                        <Space>
                            <Button 
                                type="link" 
                                onClick={() => showChangePasswordModal(record)}
                            >
                                ä¿®æ”¹å¯†ç 
                            </Button>
                            {record.username !== 'admin' && (
                                <Button 
                                    type="link" 
                                    danger 
                                    onClick={() => handleDelete(record.id)}
                                >
                                    åˆ é™¤
                                </Button>
                            )}
                        </Space>
                    ),
                }
            ];

            const loadUsers = async () => {
                try {
                    setLoading(true);
                    const response = await fetch(`${API_BASE_URL}/api/users`, {
                        credentials: 'include'
                    });
                    const data = await response.json();
                    if (data.success) {
                        const sortedUsers = data.users.sort((a, b) => 
                            new Date(a.created_at) - new Date(b.created_at)
                        );
                        setUsers(sortedUsers);
                    } else {
                        message.error(data.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    message.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                loadUsers();
            }, []);

            const handleAddUser = async (values) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/users`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(values),
                        credentials: 'include'
                    });
                    const data = await response.json();
                    if (data.success) {
                        message.success('ç”¨æˆ·åˆ›å»ºæˆåŠŸ');
                        setModalVisible(false);
                        form.resetFields();
                        loadUsers();
                    } else {
                        message.error(data.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    message.error('åˆ›å»ºç”¨æˆ·å¤±è´¥');
                }
            };

            const handleDelete = async (userId) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/users/${userId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    const data = await response.json();
                    if (data.success) {
                        message.success('ç”¨æˆ·åˆ é™¤æˆåŠŸ');
                        loadUsers();
                    } else {
                        message.error(data.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    message.error('åˆ é™¤ç”¨æˆ·å¤±è´¥');
                }
            };

            const showChangePasswordModal = (user) => {
                setSelectedUser(user);
                setPasswordModalVisible(true);
                passwordForm.resetFields();
            };

            const handleChangePassword = async (values) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/users/${selectedUser.id}/password`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(values),
                        credentials: 'include'
                    });
                    const data = await response.json();
                    if (data.success) {
                        message.success('å¯†ç ä¿®æ”¹æˆåŠŸ');
                        setPasswordModalVisible(false);
                        passwordForm.resetFields();
                    } else {
                        message.error(data.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    message.error('ä¿®æ”¹å¯†ç å¤±è´¥');
                }
            };

            return (
                <div className="site-layout-content">
                    <div style={{ marginBottom: 16 }}>
                        <Button 
                            type="primary" 
                            onClick={() => setModalVisible(true)}
                        >
                            æ·»åŠ ç”¨æˆ·
                        </Button>
                    </div>

                    <Table
                        columns={columns}
                        dataSource={users}
                        rowKey="id"
                        loading={loading}
                    />

                    <Modal
                        title="æ·»åŠ ç”¨æˆ·"
                        visible={modalVisible}
                        onCancel={() => {
                            setModalVisible(false);
                            form.resetFields();
                        }}
                        footer={null}
                    >
                        <Form
                            form={form}
                            onFinish={handleAddUser}
                            layout="vertical"
                        >
                            <Form.Item
                                name="username"
                                label="ç”¨æˆ·å"
                                rules={[{ required: true, message: 'è¯·è¾“å…¥ç”¨æˆ·å' }]}
                            >
                                <Input />
                            </Form.Item>
                            <Form.Item
                                name="password"
                                label="å¯†ç "
                                rules={[{ required: true, message: 'è¯·è¾“å…¥å¯†ç ' }]}
                            >
                                <Input.Password />
                            </Form.Item>
                            <Form.Item>
                                <Button type="primary" htmlType="submit">
                                    ç¡®å®š
                                </Button>
                            </Form.Item>
                        </Form>
                    </Modal>

                    <Modal
                        title="ä¿®æ”¹å¯†ç "
                        visible={passwordModalVisible}
                        onCancel={() => {
                            setPasswordModalVisible(false);
                            passwordForm.resetFields();
                        }}
                        footer={null}
                    >
                        <Form
                            form={passwordForm}
                            onFinish={handleChangePassword}
                            layout="vertical"
                        >
                            <Form.Item
                                name="password"
                                label="æ–°å¯†ç "
                                rules={[{ required: true, message: 'è¯·è¾“å…¥æ–°å¯†ç ' }]}
                            >
                                <Input.Password />
                            </Form.Item>
                            <Form.Item>
                                <Button type="primary" htmlType="submit">
                                    ç¡®å®š
                                </Button>
                            </Form.Item>
                        </Form>
                    </Modal>
                </div>
            );
        };

        function AdminPage() {
            const [selectedKeys, setSelectedKeys] = React.useState(['welcome']);
            const [loading, setLoading] = React.useState(false);
            const [contacts, setContacts] = React.useState([]);
            const [username, setUsername] = React.useState('');
            const [isAuthenticated, setIsAuthenticated] = React.useState(false);

            // åŠ è½½è”ç³»äººæ•°æ®
            const loadContacts = async () => {
                try {
                    setLoading(true);
                    const response = await fetch(`${API_BASE_URL}/api/contacts`, {
                        credentials: 'include',
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to load contacts');
                    }
                    
                    const data = await response.json();
                    if (data.success) {
                        setContacts(data.contacts);
                    } else {
                        message.error('åŠ è½½è”ç³»äººæ•°æ®å¤±è´¥');
                    }
                } catch (error) {
                    console.error('Load contacts failed:', error);
                    message.error('åŠ è½½è”ç³»äººæ•°æ®å¤±è´¥');
                } finally {
                    setLoading(false);
                }
            };

            // èœå•ç‚¹å‡»å¤„ç†
            const handleMenuClick = (key) => {
                setSelectedKeys([key]);
                // å¦‚æœç‚¹å‡»äº†å®¢æˆ·ç®¡ç†èœå•ï¼ŒåŠ è½½è”ç³»äººæ•°æ®
                if (key === 'contacts') {
                    loadContacts();
                }
            };

            // æ¸²æŸ“å†…å®¹åŒºåŸŸ
            const renderContent = () => {
                switch (selectedKeys[0]) {
                    case 'welcome':
                        return <Welcome />;
                    case 'contacts':
                        return <ContactList contacts={contacts} loading={loading} />;
                    case 'users':
                        return <UserManagement />;
                    default:
                        return <Welcome />;
                }
            };

            React.useEffect(() => {
                // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
                checkAuth();
            }, []);

            // èœå•é¡¹é…ç½®
            const menuItems = [
                {
                    key: 'home',
                    icon: <HomeOutlined />,
                    children: [
                        {
                            key: 'welcome',
                            icon: <DashboardOutlined />,
                            label: 'é¦–é¡µ'
                        }
                    ],
                    label: 'ä¸»é¡µ'
                },
                {
                    key: 'management',
                    icon: <SettingOutlined />,
                    children: [
                        {
                            key: 'contacts',
                            icon: <TeamOutlined />,
                            label: 'å®¢æˆ·ç®¡ç†'
                        },
                        {
                            key: 'users',
                            icon: <UserOutlined />,
                            label: 'ç”¨æˆ·ç®¡ç†'
                        }
                    ],
                    label: 'ç³»ç»Ÿç®¡ç†'
                }
            ];

            // æ£€æŸ¥è®¤è¯çŠ¶æ€
            const checkAuth = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/check-auth`, {
                        credentials: 'include'
                    });
                    const data = await response.json();
                    
                    if (!data.logged_in || !data.username) {
                        localStorage.removeItem('isLoggedIn');
                        window.location.href = 'login.html';
                        return;
                    }

                    setUsername(data.username);
                    setIsAuthenticated(true);
                } catch (error) {
                    console.error('Auth check failed:', error);
                    localStorage.removeItem('isLoggedIn');
                    window.location.href = 'login.html';
                }
            };

            // å¤„ç†ç™»å‡º
            const handleLogout = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/logout`, {
                        method: 'POST',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        localStorage.removeItem('isLoggedIn');
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error('Logout failed:', error);
                    message.error('ç™»å‡ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            };

            return (
                <Layout style={{ minHeight: '100vh' }}>
                    <Sider theme="light">
                        <div style={{ padding: '20px', textAlign: 'center' }}>
                            <h2 style={{ margin: 0 }}>ç®¡ç†åå°</h2>
                        </div>
                        <Menu
                            mode="inline"
                            selectedKeys={selectedKeys}
                            items={menuItems}
                            onClick={({ key }) => handleMenuClick(key)}
                        />
                    </Sider>
                    <Layout>
                        <Header style={{ background: '#fff', padding: '0 20px', display: 'flex', justifyContent: 'flex-end', alignItems: 'center' }}>
                            <Space>
                                <span>æ¬¢è¿ï¼Œ{username}</span>
                                <Button onClick={handleLogout}>é€€å‡ºç™»å½•</Button>
                            </Space>
                        </Header>
                        <Content style={{ margin: '24px 16px', padding: 24, background: '#fff', minHeight: 280 }}>
                            {renderContent()}
                        </Content>
                    </Layout>
                </Layout>
            );
        }

        ReactDOM.render(
            <AdminPage />,
            document.getElementById('app')
        );
    </script>
</body>
</html>