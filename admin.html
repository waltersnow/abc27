<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABC国际商服 - 后台管理</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@4.24.7/dist/antd.min.css">
    <script src="https://cdn.jsdelivr.net/npm/react@17.0.2/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17.0.2/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/min/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/antd@4.24.7/dist/antd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.18.13/babel.min.js"></script>
    <style>
        #app {
            min-height: 100vh;
        }
        .ant-layout {
            min-height: 100vh;
        }
        .admin-logo {
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 24px;
            color: #1e88e5;
            font-size: 20px;
            font-weight: bold;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
            overflow: hidden;
        }
        .ant-layout-content {
            padding: 24px;
            background: #f0f2f5;
        }
        .site-layout-content {
            padding: 24px;
            background: #fff;
            border-radius: 2px;
        }
        .ant-page-header {
            padding: 16px 24px;
            background: #fff;
            margin-bottom: 16px;
        }
        .filter-form {
            margin-bottom: 24px;
        }
        .table-container {
            background: #fff;
            padding: 24px;
            margin-bottom: 24px;
        }
        .page-subtitle {
            font-weight: bold;
            color: #000;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Layout, PageHeader, Form, Input, Select, DatePicker, Button, Table, Space, message, Menu, Dropdown, Modal } = antd;
        const { RangePicker } = DatePicker;
        const { Option } = Select;
        const { Sider, Content } = Layout;

        // API 基础URL配置
        const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_BASE_URL = isDevelopment 
            ? `http://${window.location.hostname}:5000`
            : window.location.protocol + '//' + window.location.hostname;

        // 欢迎页面组件
        const Welcome = () => {
            return (
                <div className="site-layout-content" style={{
                    display: 'flex',
                    justifyContent: 'center',
                    alignItems: 'center',
                    minHeight: '60vh',
                    fontSize: '24px',
                    color: '#1e88e5',
                    fontWeight: 'bold'
                }}>
                    欢迎登录ABC国际商服管理后台
                </div>
            );
        };

        // 用户管理组件
        const UserManagement = () => {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(false);
            const [modalVisible, setModalVisible] = useState(false);
            const [passwordModalVisible, setPasswordModalVisible] = useState(false);
            const [selectedUser, setSelectedUser] = useState(null);
            const [form] = Form.useForm();
            const [passwordForm] = Form.useForm();

            const columns = [
                {
                    title: 'ID',
                    dataIndex: 'id',
                    key: 'id',
                },
                {
                    title: '用户名',
                    dataIndex: 'username',
                    key: 'username',
                },
                {
                    title: '创建时间',
                    dataIndex: 'created_at',
                    key: 'created_at',
                    render: (text) => moment(text).format('YYYY-MM-DD HH:mm:ss'),
                    defaultSortOrder: 'ascend',
                    sorter: (a, b) => new Date(a.created_at) - new Date(b.created_at)
                },
                {
                    title: '操作',
                    key: 'action',
                    render: (_, record) => (
                        <Space>
                            <Button 
                                type="link" 
                                onClick={() => showChangePasswordModal(record)}
                            >
                                修改密码
                            </Button>
                            {record.username !== 'admin' && (
                                <Button 
                                    type="link" 
                                    danger 
                                    onClick={() => handleDelete(record.id)}
                                >
                                    删除
                                </Button>
                            )}
                        </Space>
                    ),
                }
            ];

            const loadUsers = async () => {
                try {
                    setLoading(true);
                    const response = await fetch(`${API_BASE_URL}/api/users`, {
                        credentials: 'include'
                    });
                    const data = await response.json();
                    if (data.success) {
                        const sortedUsers = data.users.sort((a, b) => 
                            new Date(a.created_at) - new Date(b.created_at)
                        );
                        setUsers(sortedUsers);
                    } else {
                        message.error(data.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    message.error('加载用户列表失败');
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                loadUsers();
            }, []);

            const handleAddUser = async (values) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/users`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(values),
                        credentials: 'include'
                    });
                    const data = await response.json();
                    if (data.success) {
                        message.success('用户创建成功');
                        setModalVisible(false);
                        form.resetFields();
                        loadUsers();
                    } else {
                        message.error(data.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    message.error('创建用户失败');
                }
            };

            const handleDelete = async (userId) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/users/${userId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    const data = await response.json();
                    if (data.success) {
                        message.success('用户删除成功');
                        loadUsers();
                    } else {
                        message.error(data.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    message.error('删除用户失败');
                }
            };

            const showChangePasswordModal = (user) => {
                setSelectedUser(user);
                setPasswordModalVisible(true);
                passwordForm.resetFields();
            };

            const handleChangePassword = async (values) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/users/${selectedUser.id}/password`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(values),
                        credentials: 'include'
                    });
                    const data = await response.json();
                    if (data.success) {
                        message.success('密码修改成功');
                        setPasswordModalVisible(false);
                        passwordForm.resetFields();
                    } else {
                        message.error(data.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    message.error('修改密码失败');
                }
            };

            return (
                <div className="site-layout-content">
                    <div style={{ marginBottom: 16 }}>
                        <Button 
                            type="primary" 
                            onClick={() => setModalVisible(true)}
                        >
                            添加用户
                        </Button>
                    </div>

                    <Table
                        columns={columns}
                        dataSource={users}
                        rowKey="id"
                        loading={loading}
                    />

                    <Modal
                        title="添加用户"
                        visible={modalVisible}
                        onCancel={() => {
                            setModalVisible(false);
                            form.resetFields();
                        }}
                        footer={null}
                    >
                        <Form
                            form={form}
                            onFinish={handleAddUser}
                            layout="vertical"
                        >
                            <Form.Item
                                name="username"
                                label="用户名"
                                rules={[{ required: true, message: '请输入用户名' }]}
                            >
                                <Input />
                            </Form.Item>
                            <Form.Item
                                name="password"
                                label="密码"
                                rules={[{ required: true, message: '请输入密码' }]}
                            >
                                <Input.Password />
                            </Form.Item>
                            <Form.Item>
                                <Button type="primary" htmlType="submit">
                                    确定
                                </Button>
                            </Form.Item>
                        </Form>
                    </Modal>

                    <Modal
                        title="修改密码"
                        visible={passwordModalVisible}
                        onCancel={() => {
                            setPasswordModalVisible(false);
                            passwordForm.resetFields();
                        }}
                        footer={null}
                    >
                        <Form
                            form={passwordForm}
                            onFinish={handleChangePassword}
                            layout="vertical"
                        >
                            <Form.Item
                                name="password"
                                label="新密码"
                                rules={[{ required: true, message: '请输入新密码' }]}
                            >
                                <Input.Password />
                            </Form.Item>
                            <Form.Item>
                                <Button type="primary" htmlType="submit">
                                    确定
                                </Button>
                            </Form.Item>
                        </Form>
                    </Modal>
                </div>
            );
        };

        function AdminPage() {
            const [selectedKeys, setSelectedKeys] = React.useState(['welcome']);
            const [loading, setLoading] = React.useState(false);
            const [contacts, setContacts] = React.useState([]);
            const [username, setUsername] = React.useState('');
            const [isAuthenticated, setIsAuthenticated] = React.useState(false);

            // 加载联系人数据
            const loadContacts = async () => {
                try {
                    setLoading(true);
                    const response = await fetch(`${API_BASE_URL}/api/contacts`, {
                        credentials: 'include',
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to load contacts');
                    }
                    
                    const data = await response.json();
                    if (data.success) {
                        setContacts(data.contacts);
                    } else {
                        message.error('加载联系人数据失败');
                    }
                } catch (error) {
                    console.error('Load contacts failed:', error);
                    message.error('加载联系人数据失败');
                } finally {
                    setLoading(false);
                }
            };

            // 菜单点击处理
            const handleMenuClick = (key) => {
                setSelectedKeys([key]);
                // 如果点击了客户管理菜单，加载联系人数据
                if (key === 'contacts') {
                    loadContacts();
                }
            };

            // 渲染内容区域
            const renderContent = () => {
                switch (selectedKeys[0]) {
                    case 'welcome':
                        return <Welcome />;
                    case 'contacts':
                        return <ContactList contacts={contacts} loading={loading} />;
                    case 'users':
                        return <UserManagement />;
                    default:
                        return <Welcome />;
                }
            };

            React.useEffect(() => {
                // 检查是否已登录
                checkAuth();
            }, []);

            // 菜单项配置
            const menuItems = [
                {
                    key: 'home',
                    icon: <HomeOutlined />,
                    children: [
                        {
                            key: 'welcome',
                            icon: <DashboardOutlined />,
                            label: '首页'
                        }
                    ],
                    label: '主页'
                },
                {
                    key: 'management',
                    icon: <SettingOutlined />,
                    children: [
                        {
                            key: 'contacts',
                            icon: <TeamOutlined />,
                            label: '客户管理'
                        },
                        {
                            key: 'users',
                            icon: <UserOutlined />,
                            label: '用户管理'
                        }
                    ],
                    label: '系统管理'
                }
            ];

            return (
                <Layout style={{ minHeight: '100vh' }}>
                    <Sider theme="light">
                        <div style={{ padding: '20px', textAlign: 'center' }}>
                            <h2 style={{ margin: 0 }}>管理后台</h2>
                        </div>
                        <Menu
                            mode="inline"
                            selectedKeys={selectedKeys}
                            items={menuItems}
                            onClick={({ key }) => handleMenuClick(key)}
                        />
                    </Sider>
                    <Layout>
                        <Header style={{ background: '#fff', padding: '0 20px', display: 'flex', justifyContent: 'flex-end', alignItems: 'center' }}>
                            <Space>
                                <span>欢迎，{username}</span>
                                <Button onClick={handleLogout}>退出登录</Button>
                            </Space>
                        </Header>
                        <Content style={{ margin: '24px 16px', padding: 24, background: '#fff', minHeight: 280 }}>
                            {renderContent()}
                        </Content>
                    </Layout>
                </Layout>
            );
        }

        ReactDOM.render(
            <AdminPage />,
            document.getElementById('app')
        );
    </script>
</body>
</html>